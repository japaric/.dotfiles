#!/bin/bash

# updates the rust nightly channel

set -ex

update_toolchain() {
    local tf=$(mktemp)
    rustup update nightly 2>&1 | tee $tf

    if cat $tf | grep -q 'nightly.*unchanged'; then
        rm $tf
        exit 0
    fi

    rm $tf
}

rebuild_packages() {
    nice -n10 cargo install -f --git https://github.com/japaric/mpc.rs &
    nice -n10 cargo install -f --git https://github.com/japaric/scripts &
    nice -n10 cargo install -f --git https://github.com/japaric/xargo &
    nice -n10 cargo install -f --git https://github.com/phildawes/racer &
    nice -n10 cargo install -f --git https://github.com/rust-lang-nursery/rustfmt &
    nice -n10 cargo install -f cargo-check &
    nice -n10 cargo install -f cargo-clone &
    nice -n10 cargo install -f cargo-edit &
    nice -n10 cargo install -f cargo-graph &
    nice -n10 cargo install -f cargo-outdated &
    nice -n10 cargo install -f cargo-watch &
    nice -n10 cargo install -f mdbook &

    pushd ~/rust/cargo-clippy
    git pull
    cargo clean
    cargo update
    # NOTE clippy breaks every now and then
    nice -n10 cargo build --release || true
    popd
}

fetch_src() {
    local hash=$(rustc -Vv | grep commit-hash | cut -d' ' -f2)

    if [ -d ~/rust/nightly ]; then
        chmod -R a+w ~/rust/nightly
        rm -r ~/rust/nightly
        mkdir ~/rust/nightly
    fi

    curl -sL https://github.com/rust-lang/rust/archive/$hash.tar.gz | \
        tar -xz -C ~/rust/nightly --strip-components 1

    rm -r ~/rust/nightly/src/test

    chmod -R a-w ~/rust/nightly
}

install_completions() {
    local sysroot=$(rustc --print sysroot)
    curl -sSL https://raw.githubusercontent.com/rust-lang-nursery/rustup.rs/master/src/rustup-cli/zsh/_rustup > $sysroot/share/zsh/site-functions/_rustup
}

main() {
    update_toolchain
    rebuild_packages
    fetch_src
    install_completions
}

main
