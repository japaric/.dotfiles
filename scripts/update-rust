#!/bin/bash

# updates the rust nightly channel

set -ex

update_toolchain() {
  output=$(multirust update nightly | tee /dev/tty)

  if echo $output | grep -q 'is already up to date'; then
    exit 0
  fi
}

uninstall() {
  cargo uninstall $1 2>/dev/null || true
}

# TODO(rust-lang/cargo#2405) use cargo install --update
rebuild_packages() {
  uninstall cargo-check
  cargo install --git https://github.com/rsolomo/cargo-check

  uninstall cargo-edit
  cargo install --git https://github.com/killercup/cargo-edit

  uninstall cargo-outdated
  cargo install --git https://github.com/kbknapp/cargo-outdated

  uninstall cargo-watch
  cargo install --git https://github.com/passcod/cargo-watch

  uninstall dybuk
  cargo install --git https://github.com/Ticki/dybuk

  uninstall mdbook
  cargo install --git https://github.com/azerupi/mdBook

  uninstall mpd
  cargo install --path ~/rust/mpc

  uninstall rustfmt
  cargo install --git https://github.com/rust-lang-nursery/rustfmt

  uninstall scripts
  cargo install --path ~/rust/scripts

  pushd ~/rust/cargo-clippy
  git pull
  cargo clean
  cargo update
  cargo build --release
  popd
}

fetch_src() {
  local date=$(curl -sL https://static.rust-lang.org/dist/channel-rust-nightly.toml | grep date | cut -d'"' -f2)

  if [ -d ~/rust/nightly ]; then
    chmod -R a+w ~/rust/nightly
    rm -r ~/rust/nightly
    mkdir ~/rust/nightly
  fi

  curl -sL https://static.rust-lang.org/dist/$date/rustc-nightly-src.tar.gz | \
    tar xz -C ~/rust/nightly --strip-components 1

  chmod -R a-w ~/rust/nightly
}

main() {
  update_toolchain
  rebuild_packages
  fetch_src
}

main
