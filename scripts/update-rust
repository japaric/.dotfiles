#!/bin/bash

# updates the rust nightly channel

set -ex

update_toolchain() {
    local tf=$(mktemp)
    rustup update nightly 2>&1 | tee $tf

    if cat $tf | grep -q 'nightly.*unchanged'; then
        rm $tf
        exit 0
    fi

    rm $tf
}

rebuild_packages() {
    nice -n10 cargo install -f --git https://github.com/japaric/mpc.rs &
    nice -n10 cargo install -f --git https://github.com/japaric/scripts &
    nice -n10 cargo install -f --git https://github.com/phildawes/racer &
    nice -n10 cargo install -f --git https://github.com/rust-lang-nursery/rustfmt &
    nice -n10 cargo install -f cargo-check &
    nice -n10 cargo install -f cargo-clone &
    nice -n10 cargo install -f cargo-edit &
    nice -n10 cargo install -f cargo-graph &
    nice -n10 cargo install -f cargo-outdated &
    nice -n10 cargo install -f cargo-watch &
    nice -n10 cargo install -f mdbook &
    LIBGIT2_SYS_USE_PKG_CONFIG=1 nice -n10 cargo install -f xargo &

    pushd ~/rust/cargo-clippy
    git pull
    cargo clean
    cargo update
    # NOTE clippy breaks every now and then
    nice -n10 cargo build --release || true
    popd
}

install_completions() {
    local sysroot=$(rustc --print sysroot)
    curl -sSL https://raw.githubusercontent.com/rust-lang-nursery/rustup.rs/master/src/rustup-cli/zsh/_rustup > $sysroot/share/zsh/site-functions/_rustup
}

main() {
    update_toolchain
    rebuild_packages
    install_completions
}

main
